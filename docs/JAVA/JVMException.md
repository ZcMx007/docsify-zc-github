# JVM异常分析
记录JVM虚拟机中出现的异常信息，并给出解决方案

## unable to create native thread

这种错误主要是出现在32位的系统中，因为32位的系统中会限定一个Java进程最多跑满2G，HotSpot虚拟机提供了参数可以控制Java堆和方法区这两部分的内存的最大值，那剩余的内存[即为2GB（操作系统限制）减去最大堆容量，再减去最大方法区容量]，由于程序计数器消耗内存很小，可以忽略掉，如果把直接内存和虚拟机进程本身耗费的内存也去掉的话，剩下的内存就由虚拟机栈和本地方法栈来分配了。而java中Hotspot虚拟机中的栈内存是不允许扩展的（即不允许像堆一样设置标准值的同时设置最大值用于扩展，但可以设置标准值），因此只会报StackOverflowError异常，而不会报OutOfMemoryError异常，由此可知OOM错误报的超出内存大小是指的超出最大设定的内存分配大小的含义。同时，我们知道虚拟机栈和本地方法栈以及程序计数器是独属于线程的，因此设置的栈内存是独属于每个线程的栈内存大小，由此得知，每个线程的创建会附属一个栈内存的分配给创建的线程，除非线程销毁这部分栈内存才会被回收。因此为每个线程分配到的栈内存越大，可以建立的线程数量自然就越少，建立线程时就越容易把剩下的内存耗尽。在这种情况下，会导致unable to create native thread该OOM异常的发生，当然，有些虚拟机也会友好的注明“possibly out of memory or process/resource limits reached”。在不能减少线程数量或者更换64位虚拟机的情况下，发生这种异常就只能通过减少最大堆和减少栈容量来换取更多的线程。

## Exception in thread "main" java.lang.OutOfMemoryError

由直接内存导致的内存溢出，一个明显的特征是在Heap Dump文件中不会看见有什么明显的异常
情况，如果读者发现内存溢出之后产生的Dump文件很小，而程序中又直接或间接使用了
DirectMemory（典型的间接使用就是NIO），那就可以考虑重点检查一下直接内存方面的原因了。


